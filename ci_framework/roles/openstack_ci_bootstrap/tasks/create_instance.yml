- name: Create {{ cifmw_ocb_create_instance_name }} instance
  vars:
    sanitized_instance_name: >-
      {{
        ( 'cifmw-instance-' +
          cifmw_ocb_create_instance_name + '-' +
          cifmw_ocb_resource_suffix
        ) |
        regex_replace('[^a-zA-Z0-9-]', '-')
      }}
  register: cifmw_ocb_create_instance_status_out
  ansible.builtin.command:
    cmd: >-
      openstack server create
      --flavor {{ cifmw_ocb_create_instance_flavor}}
      --image {{ cifmw_ocb_create_instance_image}}
      {% for net in cifmw_ocb_create_instance_networks %}--network {{ net }}{% endfor %}
      --key-name {{ cifmw_ocb_instance_key_name }}
      -f yaml
      {{ sanitized_instance_name }}

- name: Create {{ cifmw_ocb_create_instance_name }} instance creation data
  ansible.builtin.set_fact:
    cifmw_ocb_resources: >-
      {{
        cifmw_ocb_resources | default({'instances':[]}) |
        combine(
          {
           'instances': (
              cifmw_ocb_resources['instances']
              if cifmw_ocb_resources is defined and
                'instances' in cifmw_ocb_resources else []
            ) + [cifmw_ocb_create_instance_status_out.stdout | from_yaml]
          }
        )
      }}
    cacheable: true

- name: Wait for the {{ cifmw_ocb_create_instance_name }} instance to be ready
  register: cifmw_ocb_create_instance_wait_status_out
  ansible.builtin.command:
    cmd: >-
      openstack server show
      -f value
      -c status
      {{ (cifmw_ocb_create_instance_status_out.stdout | from_yaml).id }}
  until: >-
    cifmw_ocb_create_instance_wait_status_out.rc == 0 and
    cifmw_ocb_create_instance_wait_status_out.stdout | lower == 'active'
  retries: "{{ cifmw_ocb_wait_instance_retries }}"
  delay: "{{ cifmw_ocb_wait_instance_delay }}"

- name: Create and attach floating IP
  when: cifmw_ocb_create_attach_fip is defined and cifmw_ocb_create_attach_fip | bool
  block:
    - name: Create floating IP
      register: cifmw_ocb_create_instance_fip_out
      ansible.builtin.command:
        cmd: >-
          openstack floating ip create
          -f yaml
          --tag cifmw-resource-{{ cifmw_ocb_resource_suffix }}
          {{ cifmw_ocb_external_network }}

    - name: Save floating IP resource data
      ansible.builtin.set_fact:
        cifmw_ocb_resources: >-
          {{
            cifmw_ocb_resources |
            combine(
              {
              'fips': (
                  cifmw_ocb_resources['fips']
                  if 'fips' in cifmw_ocb_resources else []
                ) + [cifmw_ocb_create_instance_fip_out.stdout | from_yaml]
              }
            )
          }}
        cacheable: true

    - name: Attach floating IP to instance
      register: cifmw_ocb_create_instance_fip_out
      ansible.builtin.command:
        cmd: >-
          openstack server add floating ip
          {{ (cifmw_ocb_create_instance_status_out.stdout | from_yaml).id }}
          {{ (cifmw_ocb_create_instance_fip_out.stdout | from_yaml).id }}
