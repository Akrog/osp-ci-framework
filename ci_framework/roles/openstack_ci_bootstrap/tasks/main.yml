---
# Copyright Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.


- name: Create resources
  environment:
    OS_CLOUD: "{{ cifmw_ocb_net_cloud_name }}"
  block:
    - name: Create network resources
      ansible.builtin.import_tasks: network_setup.yml

    - name: Create the instances
      vars:
        cifmw_ocb_create_instance_name: "{{ item.name }}"
        cifmw_ocb_create_instance_flavor: "{{ item.flavor }}"
        cifmw_ocb_create_instance_image: "{{ item.image }}"
        cifmw_ocb_create_attach_fip: "{{ item.attach_fip | default(true) }}"
        cifmw_ocb_create_instance_networks:
          - "{{ cifmw_ocb_network_name }}"
      ansible.builtin.include_tasks: create_instance.yml
      loop: "{{ cifmw_ocb_instances | default([]) }}"
      loop_control:
        label: "{{ item.name }}"

  rescue:
    - name: Cleanup resources in case of failure
      ansible.builtin.import_tasks: cleanup.yml

    - name: Failure occurred
      ansible.builtin.fail:
        msg: A prvious failure occurred deploying resources to OpenStack

- name: Ensure ci-framework-data directory exists
  ansible.builtin.file:
    path: "{{ ansible_user_dir }}/ci-framework-data/artifacts"
    state: directory

- name: Save generated infraestructure resources data
  vars:
    cifmw_ocb_infra_file_content:
      cifmw_ocb_resources: "{{ cifmw_ocb_resources }}"
  ansible.builtin.copy:
    dest: "{{ ansible_user_dir }}/ci-framework-data/artifacts/infra-resources.yml"
    content: "{{ cifmw_ocb_infra_file_content | to_nice_yaml }}"
